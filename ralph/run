#!/bin/bash
set -e

MAX_ITERATIONS=${1:-10}

echo "Starting Ralph loop (max $MAX_ITERATIONS iterations)"
echo ""

for ((i=1; i<=MAX_ITERATIONS; i++)); do
    # Sync with remote to get latest issues and priority changes
    echo "Syncing with remote..."
    bd sync 2>/dev/null || true

    # Check if there's work available
    if [[ -z "$(bd list --status open -n 1 2>/dev/null)" ]]; then
        echo "No open issues remaining. Sleeping for 1 minute..."
        sleep 60
        ((i--))  # Don't count sleep iterations towards MAX_ITERATIONS
        continue
    fi

    echo "=========================================="
    echo "Ralph iteration $i of $MAX_ITERATIONS"
    echo "=========================================="

    claude "Read ./ralph/RALPH.md and get to work" \
        --dangerously-skip-permissions \
        --output-format stream-json \
        --verbose \
        --include-partial-messages \
        | node .devcontainer/parse-claude-stream.js
done

echo ""
echo "Ralph loop finished after $((i-1)) iteration(s)"