# Progress Log

...snip...

## Session 1 - 2026-01-19

### Task: bead-fu9 - Replace vitest with bun:test for all unit tests

**Status:** Completed

**Problem Solved:**
The project was using vitest for unit tests, but since the project uses Bun as its runtime and package manager, it made sense to use Bun's built-in test framework (`bun:test`) for consistency and to reduce dependencies.

**Solution Implemented:**
Migrated all 306 unit tests from vitest to bun:test:

1. **Created test-preload.ts** - Sets up the test environment:
   - Uses `@happy-dom/global-registrator` to provide DOM APIs (replaces jsdom)
   - Extends `expect` with `@testing-library/jest-dom` matchers
   - Mocks `ResizeObserver` for React Flow components

2. **Created bun-test.d.ts** - TypeScript declarations for jest-dom matchers in bun:test

3. **Updated bunfig.toml** - Added preload configuration for test setup

4. **Migrated all test files**:
   - Changed imports from `'vitest'` to `'bun:test'`
   - Replaced `vi.spyOn` with `spyOn`
   - Replaced `vi.fn()` with `mock()`
   - Replaced `vi.mock()` with `mock.module()`
   - Converted `describe.each` (vitest-specific) to for loops
   - Added `cleanup()` calls after each React component test for DOM isolation

5. **Fixed Toast tests**:
   - Removed fake timers (caused test isolation issues with happy-dom)
   - Used real timers with `waitFor()` instead

6. **Updated package.json**:
   - Changed `"test"` script to use `bun test` with explicit file list
   - Added `"test:integration"` script for server integration tests
   - Removed vitest and jsdom from devDependencies
   - Added `@happy-dom/global-registrator` as devDependency

7. **Deleted obsolete files**:
   - `vitest.config.ts`
   - `src/test-setup.ts`

**Technical Notes:**
- happy-dom returns hex colors while jsdom returns rgb() - tests updated to accept both formats
- Server integration tests (api/server.test.ts) excluded from unit test run as they require a running server
- Mock module syntax is different: `mock.module()` returns a promise and must be at top level

**Tests:** All 306 unit tests pass. TypeScript compiles. Biome lint passes. Build succeeds.

**Files Changed:**
- test-preload.ts (new)
- bun-test.d.ts (new)
- bunfig.toml (added preload)
- tsconfig.json (added new files to include)
- package.json (updated scripts, dependencies)
- vitest.config.ts (deleted)
- src/test-setup.ts (deleted)
- All *.test.ts and *.test.tsx files (migrated imports and mocking patterns)

## Session 2 - 2026-01-19

### Task: bead-62u - Make bun test run all tests including e2e

**Status:** Completed

**Problem Solved:**
The `bun test` command was configured to run only a curated list of unit tests, while e2e tests required a separate script (`scripts/e2e.ts`) that orchestrated server startup, test execution, and cleanup. The goal was to make e2e tests self-contained so `bun test` runs ALL tests including e2e.

**Solution Implemented:**
Made e2e tests self-contained by moving server startup/shutdown into the test file itself:

1. **Created e2e/setup.ts** - Server management utilities:
   - `startServers()` - Starts Vite + API servers on test ports (5174, 3002)
   - `stopServers()` - Shuts down servers and cleans up temp directory
   - Creates temp data directory for test isolation
   - Initializes local beads repo for /local route
   - Waits for servers to be ready before returning

2. **Updated e2e/load-beads-issues.test.ts**:
   - Added `await startServers()` in `beforeAll`
   - Added `await stopServers()` in `afterAll`
   - Imported server utilities from `./setup`

3. **Updated package.json**:
   - Changed `"test"` to `"bun test"` (runs all tests)
   - Changed `"test:watch"` to `"bun test --watch"`
   - Added `"test:unit"` for running only unit tests (previous curated list)
   - Changed `"test:e2e"` to `"bun test e2e/"` (runs only e2e)

4. **Updated ./check**:
   - Changed to use `bun run test:unit` for quality gates
   - This keeps CI/quick checks fast by skipping e2e tests

5. **Deleted scripts/e2e.ts**:
   - No longer needed since e2e tests are self-contained

**Result:**
After implementation:
- `bun test` - Runs ALL tests (unit, integration, e2e)
- `bun test src/` - Runs only source unit tests (136 tests)
- `bun test e2e/` - Runs only e2e tests
- `bun run test:unit` - Runs curated unit test list (306 tests)
- `./check` - Runs unit tests only (fast quality gates)

**Tests:** All 306 unit tests pass. TypeScript compiles. Biome lint passes. Build succeeds.

**Files Changed:**
- e2e/setup.ts (new)
- e2e/load-beads-issues.test.ts (added server startup/shutdown)
- package.json (updated scripts)
- check (updated to use test:unit)
- scripts/e2e.ts (deleted)

## Session 3 - 2026-01-19

### Task: bead-yik - Fix the e2e tests

**Status:** Completed

**Problem Solved:**
Running `bun run test:e2e` was failing because the `beforeAll` hook in `e2e/load-beads-issues.test.ts` timed out before servers could start. The root cause was that bun:test has a default 5-second timeout for hooks, but starting the Vite and API servers takes longer than that.

**Solution Implemented:**
Added timeout parameters to the `beforeAll` and `afterAll` hooks:

1. **beforeAll hook (line 309)**: Added 60-second timeout
   - Server startup takes ~10-30 seconds depending on cold start
   - Browser launch adds additional time
   - 60 seconds provides buffer for slow environments

2. **afterAll hook (line 318)**: Added 30-second timeout
   - Browser close and cleanup operations
   - Fork deletion via GitHub API
   - Server shutdown

**Technical Notes:**
- bun:test hooks accept an optional second parameter for timeout in milliseconds
- The test itself already had a 240-second (4 minute) timeout at line 1005
- This fix ensures the hooks complete before bun:test's default 5-second limit

**Tests:** All 306 unit tests pass. TypeScript compiles. Biome lint passes. Build succeeds.

**Files Changed:**
- e2e/load-beads-issues.test.ts (added timeout parameters to beforeAll and afterAll hooks)

## Session 4 - 2026-01-19

### Task: bead-cqy - Rework e2e test structure

**Status:** Completed

**Problem Solved:**
The e2e test file `e2e/load-beads-issues.test.ts` contained helper functions and types that should be shared utilities in the setup module. The file also had a generic name that didn't clearly describe its purpose.

**Solution Implemented:**
Refactored the e2e test for better organization:

1. **Moved helper functions to e2e/setup.ts**:
   - `createTestFork()` - Creates a GitHub fork for testing
   - `cloneFork()` - Clones a fork to a temp directory
   - `deleteFork()` - Deletes a test fork
   - `cleanupClonedRepo()` - Cleans up cloned repo directory
   - `extractBeadsData()` - Extracts issues/dependencies via beads CLI
   - `pullAndExtractBeadsData()` - Pulls changes and extracts data
   - `waitForVisible()` - Playwright helper for visibility check
   - `waitForHidden()` - Playwright helper for hidden check
   - `takeScreenshot()` - Saves screenshots to screenshots directory

2. **Moved types to e2e/setup.ts**:
   - `BeadsIssue` - Issue data from beads CLI
   - `BeadsDependency` - Dependency data from beads CLI
   - `BeadsData` - Container for issues and dependencies from CLI
   - `DagIssue` - Issue data extracted from DAG view
   - `DagDependency` - Dependency data from DAG view
   - `DagData` - Container for issues and dependencies from UI

3. **Renamed test file and description**:
   - File: `e2e/load-beads-issues.test.ts` → `e2e/github-beads-issues.test.ts`
   - Test: "Load beads issues from GitHub repository" → "adds beads issues to github repositories"

4. **Updated function signatures**:
   - `createTestFork()` now takes `sourceOwner` and `sourceRepo` as parameters (moved constants out)
   - `pullAndExtractBeadsData()` now takes `forkRepoName` as an explicit parameter
   - `takeScreenshot()` now takes `page` as a parameter (decoupled from global state)

**Tests:** All 306 unit tests pass. TypeScript compiles. Biome lint passes. Build succeeds.

**Files Changed:**
- e2e/setup.ts (added helpers and types)
- e2e/load-beads-issues.test.ts → e2e/github-beads-issues.test.ts (renamed, updated imports)

## Session 5 - 2026-01-19

### Task: bead-jzg - Make ./check run all tests including integration and e2e

**Status:** Completed

**Problem Solved:**
The `./check` script only ran `bun run test:unit` (306 unit tests), excluding integration tests (`api/server.test.ts`) and e2e tests (`e2e/github-beads-issues.test.ts`). The goal was to update `./check` to run `bun test` which includes all tests, and fix any failing tests.

**Issues Found and Fixed:**

1. **Integration tests failing with undefined response**:
   - Root cause: `src/App.test.tsx` mocked `globalThis.fetch` in `beforeEach` but never restored it in `afterEach`
   - When tests ran in parallel, the mocked fetch polluted `api/server.test.ts`, causing all fetch calls to return the mock's `{ ok: true, json: () => ... }` object structure instead of real responses
   - Fix: Added `afterEach` to restore original `globalThis.fetch` and `EventSource` in `App.test.tsx`

2. **E2E tests failing with CORS errors**:
   - Root cause: `test-preload.ts` registers happy-dom, which replaces `globalThis.fetch` with its own CORS-enforcing implementation
   - The e2e setup's `waitForServer` function used `fetch()` to poll for server readiness, but happy-dom's fetch blocked cross-origin requests to localhost
   - Fix: Used `Bun.fetch` directly in `e2e/setup.ts`, which bypasses happy-dom's fetch replacement

3. **E2E test failing on UI element timeout**:
   - Root cause: Test was looking for `[data-testid="fab-create-issue"]` but the actual test ID is `fab-issue-assistant`
   - Fix: Updated test ID reference in `e2e/github-beads-issues.test.ts`

4. **Integration test hook timeouts**:
   - Increased `beforeAll` timeout from 5s to 60s in `api/server.test.ts`
   - Added `serverReady` flag to prevent false rejections when server exits normally

5. **TypeScript error with unused @ts-expect-error**:
   - Removed unnecessary `@ts-expect-error` directive in `App.test.tsx` since happy-dom provides EventSource type

**Solution Implemented:**

1. **Updated `./check`**: Changed from `bun run test:unit` to `bun test` to run all tests
2. **Fixed fetch pollution**: Added proper cleanup in `App.test.tsx` to restore original fetch
3. **Fixed e2e fetch**: Used `Bun.fetch` in `e2e/setup.ts` to bypass happy-dom's CORS restrictions
4. **Fixed e2e test ID**: Corrected the floating action button test ID

**Technical Notes:**
- happy-dom provides a browser-like fetch implementation that enforces Same Origin Policy
- `Bun.fetch` is not replaced by happy-dom and works without CORS restrictions
- Tests can pollute globals when running in parallel without proper cleanup

**Tests:** All 340 tests pass (306 unit + 33 integration + 1 e2e). TypeScript compiles. Biome lint passes. Build succeeds.

**Files Changed:**
- check (updated to run `bun test` instead of `bun run test:unit`)
- src/App.test.tsx (added fetch/EventSource cleanup in afterEach)
- e2e/setup.ts (use Bun.fetch for server polling)
- e2e/github-beads-issues.test.ts (fixed fab-create-issue → fab-issue-assistant)
- api/server.test.ts (increased hook timeout, improved error handling)
